<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundvertise Studio | TikTok Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; }
        .iphone { width: 280px; aspect-ratio: 9/16; border: 8px solid #1a1a1a; border-radius: 40px; position: relative; overflow: hidden; background: #000; }
        .video-box { width: 100%; height: 100%; position: relative; }
        #main-video { width: 100%; height: 100%; object-fit: cover; }
        #caption-overlay { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); width: 80%; text-align: center; z-index: 10; font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; text-shadow: 2px 2px 0 #000; cursor: move; }
        .terminal { background: #000; border: 1px solid #333; font-family: monospace; font-size: 10px; color: #0f0; padding: 10px; height: 120px; overflow-y: auto; border-radius: 12px; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 12px; border-radius: 12px; font-weight: 900; text-transform: uppercase; font-size: 12px; transition: 0.3s; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="max-w-5xl w-full grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="flex flex-col items-center gap-4">
            <div class="iphone">
                <div class="video-box">
                    <video id="main-video" loop playsinline crossorigin="anonymous"></video>
                    <div id="caption-overlay">IL TUO TESTO</div>
                </div>
            </div>
            <p class="text-[10px] text-zinc-500 uppercase font-bold tracking-widest">Anteprima Real-time</p>
        </div>

        <div class="bg-zinc-900/50 p-6 rounded-[24px] border border-zinc-800 space-y-6">
            <h1 class="font-black italic text-xl">SOUNDVERTISE <span class="text-blue-500">STUDIO</span></h1>

            <div class="grid grid-cols-2 gap-4">
                <input type="file" id="v-input" accept="video/*" class="hidden">
                <button onclick="document.getElementById('v-input').click()" class="bg-zinc-800 p-3 rounded-lg text-xs font-bold border border-zinc-700">CARICA VIDEO</button>
                
                <input type="file" id="a-input" accept="audio/*" class="hidden">
                <button onclick="document.getElementById('a-input').click()" class="bg-zinc-800 p-3 rounded-lg text-xs font-bold border border-zinc-700">CARICA AUDIO</button>
            </div>

            <textarea id="t-input" placeholder="Scrivi il testo qui..." class="w-full bg-black border border-zinc-800 p-3 rounded-xl text-sm outline-none focus:border-blue-500 h-20"></textarea>

            <div class="space-y-2">
                <button id="export-btn" class="w-full btn-primary">Esporta Video MP4</button>
                <div id="progress-container" class="hidden">
                    <div class="flex justify-between text-[10px] mb-1"><span id="status-text">Inizializzazione...</span><span id="percent">0%</span></div>
                    <div class="w-full bg-zinc-800 h-1 rounded-full"><div id="bar" class="bg-blue-500 h-full w-0"></div></div>
                </div>
            </div>

            <div class="terminal" id="terminal">
                <div>> Sistema pronto. In attesa di file...</div>
            </div>
        </div>
    </div>

    <audio id="main-audio" crossorigin="anonymous"></audio>

    <script>
        lucide.createIcons();
        const { createFFmpeg, fetchFile } = FFmpeg;

        // Inizializzazione Log
        const term = document.getElementById('terminal');
        function logger(msg) {
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            term.appendChild(d);
            term.scrollTop = term.scrollHeight;
        }

        // Controllo Sicurezza SharedArrayBuffer
        if (!window.SharedArrayBuffer) {
            logger("!!! ERRORE SICUREZZA: SharedArrayBuffer non attivo.");
            logger("Assicurati che vercel.json sia presente e fai il deploy.");
        }

        const ffmpeg = createFFmpeg({ 
            log: true, 
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
        });

        ffmpeg.setLogger(({ message }) => logger(message));

        const video = document.getElementById('main-video');
        const audio = document.getElementById('main-audio');
        const caption = document.getElementById('caption-overlay');
        let vFile, aFile;

        // Gestione Input
        document.getElementById('v-input').onchange = (e) => {
            vFile = e.target.files[0];
            video.src = URL.createObjectURL(vFile);
            logger("Video caricato: " + vFile.name);
        };

        document.getElementById('a-input').onchange = (e) => {
            aFile = e.target.files[0];
            audio.src = URL.createObjectURL(aFile);
            logger("Audio caricato: " + aFile.name);
        };

        document.getElementById('t-input').oninput = (e) => {
            caption.innerText = e.target.value || "IL TUO TESTO";
        };

        // EXPORT
        document.getElementById('export-btn').onclick = async () => {
            if (!vFile) return alert("Carica almeno un video!");
            
            document.getElementById('progress-container').classList.remove('hidden');
            const bar = document.getElementById('bar');
            const per = document.getElementById('percent');

            try {
                if (!ffmpeg.isLoaded()) {
                    logger("Caricamento FFmpeg Core...");
                    await ffmpeg.load();
                }

                logger("Scrittura file nel sistema virtuale...");
                ffmpeg.FS('writeFile', 'video.mp4', await fetchFile(vFile));
                
                let args = [];
                if (aFile) {
                    ffmpeg.FS('writeFile', 'audio.mp3', await fetchFile(aFile));
                    // Semplice merge audio/video
                    args = ['-i', 'video.mp4', '-i', 'audio.mp3', '-c:v', 'copy', '-c:a', 'aac', '-map', '0:v:0', '-map', '1:a:0', '-shortest', 'out.mp4'];
                } else {
                    args = ['-i', 'video.mp4', '-c:v', 'copy', 'out.mp4'];
                }

                ffmpeg.setProgress(({ ratio }) => {
                    const p = Math.floor(ratio * 100);
                    bar.style.width = p + '%';
                    per.innerText = p + '%';
                });

                logger("Esecuzione comando FFmpeg...");
                await ffmpeg.run(...args);

                logger("Lettura file finale...");
                const data = ffmpeg.FS('readFile', 'out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                const link = document.createElement('a');
                link.href = url;
                link.download = "video_soundvertise.mp4";
                link.click();
                
                logger("ESPORTAZIONE COMPLETATA!");
            } catch (err) {
                logger("ERRORE: " + err.message);
                console.error(err);
            }
        };

        // Drag Testo
        let isDown = false;
        caption.onmousedown = () => isDown = true;
        window.onmouseup = () => isDown = false;
        window.onmousemove = (e) => {
            if (!isDown) return;
            const rect = video.getBoundingClientRect();
            let y = e.clientY - rect.top;
            caption.style.top = y + "px";
        };
    </script>
</body>
</html>
