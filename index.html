<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundvertise Studio - Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --sv-blue: #3B82F6; --sv-purple: #8B5CF6; }
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
        .iphone-frame { width: 280px; aspect-ratio: 9/16; border: 10px solid #1A1A1A; border-radius: 40px; position: relative; background: #000; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 70px; height: 20px; background: #000; border-radius: 20px; z-index: 50; }
        .video-container { width: 100%; height: 100%; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #caption-overlay { position: absolute; top: 35%; left: 50%; transform: translateX(-50%); width: 85%; text-align: center; z-index: 30; font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; text-shadow: 2px 2px 0 #000; cursor: move; font-size: 24px; pointer-events: auto; }
        .controls-card { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 32px; padding: 32px; width: 420px; }
        .waveform-wrapper { position: relative; width: 100%; height: 70px; background: #111; border-radius: 12px; overflow: hidden; border: 1px solid #222; }
        #audio-highlighter { position: absolute; top: 0; height: 100%; background: rgba(59, 130, 246, 0.2); border-left: 2px solid var(--sv-blue); border-right: 2px solid var(--sv-blue); }
        .btn-sv { background: linear-gradient(135deg, var(--sv-blue), var(--sv-purple)); transition: 0.3s; font-weight: 800; text-transform: uppercase; cursor: pointer; }
        .terminal { background: #000; border: 1px solid #222; font-family: monospace; font-size: 9px; color: #4ade80; padding: 10px; height: 80px; overflow-y: auto; border-radius: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="flex flex-col lg:flex-row items-center gap-10 p-6 max-w-6xl w-full">
        <div class="iphone-frame">
            <div class="notch"></div>
            <div class="video-container">
                <video id="main-video" loop playsinline crossorigin="anonymous"></video>
                <div id="caption-overlay">TESTO VIDEO</div>
            </div>
        </div>

        <div class="controls-card space-y-6">
            <h1 class="text-2xl font-black italic italic">SV <span class="text-blue-500">STUDIO</span></h1>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('v-in').click()" class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl text-[10px] font-bold">CARICA VIDEO</button>
                <input type="file" id="v-in" accept="video/*" class="hidden">
                <button onclick="document.getElementById('a-in').click()" class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl text-[10px] font-bold">CARICA AUDIO</button>
                <input type="file" id="a-in" accept="audio/*" class="hidden">
            </div>

            <div class="bg-black p-4 rounded-2xl border border-zinc-800">
                <div class="flex items-center gap-4">
                    <button id="play-btn" class="w-12 h-12 rounded-full btn-sv flex items-center justify-center"><i data-lucide="play" class="fill-white" id="play-icon"></i></button>
                    <div class="flex-1">
                        <div class="waveform-wrapper"><div id="audio-highlighter"></div></div>
                        <input type="range" id="sync-slider" class="w-full mt-2 accent-blue-500" min="0" value="0" step="0.01">
                    </div>
                </div>
            </div>

            <textarea id="text-in" placeholder="Testo..." class="w-full bg-black border border-zinc-800 rounded-2xl p-4 text-sm h-20 outline-none resize-none"></textarea>
            <button id="export-btn" class="w-full btn-sv py-5 rounded-2xl text-xs">GENERA MP4</button>

            <div id="progress-box" class="hidden space-y-2">
                <div class="w-full bg-zinc-800 h-1.5 rounded-full overflow-hidden"><div id="bar" class="bg-blue-500 h-full w-0"></div></div>
            </div>

            <div class="terminal" id="terminal"></div>
        </div>
    </div>

    <audio id="main-audio" crossorigin="anonymous"></audio>

    <script>
        lucide.createIcons();
        const { createFFmpeg, fetchFile } = FFmpeg;

        // --- CORREZIONE DEFINITIVA PER proxy_main ---
        const ffmpeg = createFFmpeg({ 
            log: true, 
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js',
            mainName: 'main' // Forza l'uso di main invece di proxy_main per evitare l'errore SharedArrayBuffer
        });

        const video = document.getElementById('main-video');
        const audio = document.getElementById('main-audio');
        const caption = document.getElementById('caption-overlay');
        const term = document.getElementById('terminal');

        function addLog(m) { const d = document.createElement('div'); d.innerText = `> ${m}`; term.appendChild(d); term.scrollTop = term.scrollHeight; }
        ffmpeg.setLogger(({ message }) => addLog(message));

        document.getElementById('text-in').oninput = (e) => caption.innerText = e.target.value || 'TESTO VIDEO';
        document.getElementById('v-in').onchange = (e) => { video.src = URL.createObjectURL(e.target.files[0]); };
        document.getElementById('a-in').onchange = (e) => { 
            audio.src = URL.createObjectURL(e.target.files[0]);
            audio.onloadedmetadata = () => {
                document.getElementById('sync-slider').max = Math.max(0, audio.duration - video.duration);
                document.getElementById('audio-highlighter').style.width = (video.duration / audio.duration * 100) + '%';
            };
        };

        document.getElementById('sync-slider').oninput = (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('audio-highlighter').style.left = (val / audio.duration * 100) + '%';
            audio.currentTime = val;
        };

        document.getElementById('play-btn').onclick = () => {
            if (video.paused) { video.play(); audio.play(); } else { video.pause(); audio.pause(); }
        };

        document.getElementById('export-btn').onclick = async () => {
            if (!video.src) return alert("Carica un video!");
            document.getElementById('progress-box').classList.remove('hidden');
            
            try {
                if (!ffmpeg.isLoaded()) {
                    addLog("Caricamento motore (Main Mode)...");
                    await ffmpeg.load();
                }

                addLog("Scrittura file...");
                ffmpeg.FS('writeFile', 'in.mp4', await fetchFile(document.getElementById('v-in').files[0]));
                
                let args = ['-i', 'in.mp4', '-c:v', 'copy', 'out.mp4'];

                if (document.getElementById('a-in').files[0]) {
                    ffmpeg.FS('writeFile', 'aud.mp3', await fetchFile(document.getElementById('a-in').files[0]));
                    const start = document.getElementById('sync-slider').value;
                    args = ['-i', 'in.mp4', '-ss', start, '-t', video.duration.toFixed(2), '-i', 'aud.mp3', '-map', '0:v:0', '-map', '1:a:0', '-c:v', 'copy', '-c:a', 'aac', '-shortest', 'out.mp4'];
                }

                await ffmpeg.run(...args);
                const data = ffmpeg.FS('readFile', 'out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a'); a.href = url; a.download = 'video_final.mp4'; a.click();
                addLog("ESPORTAZIONE COMPLETATA!");

            } catch (err) {
                addLog("ERRORE: " + err.message);
            }
        };

        // Drag Testo
        let drag = false;
        caption.onmousedown = () => drag = true;
        window.onmouseup = () => drag = false;
        window.onmousemove = (e) => {
            if (!drag) return;
            const rect = video.getBoundingClientRect();
            caption.style.top = (e.clientY - rect.top) + 'px';
        };
    </script>
</body>
</html>
