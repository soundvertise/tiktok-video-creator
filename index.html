<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Video Creator | Soundvertise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&family=Courier+Prime:wght@400;700&family=Inter:wght@400;600;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --sv-purple: #8B5CF6; --sv-blue: #3B82F6; --sv-bg: #050505; --sv-card: #0F0F0F; }
        body { background-color: var(--sv-bg); color: #ffffff; font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-x: hidden; }

        .iphone-frame { width: 290px; aspect-ratio: 9 / 16; border: 10px solid #1A1A1A; border-radius: 42px; position: relative; background: #000; overflow: hidden; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 75px; height: 22px; background: #000; border-radius: 20px; z-index: 50; border: 1px solid #222; }
        .video-container { width: 100%; height: 100%; position: relative; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }

        #caption-overlay { 
            position: absolute; cursor: move; user-select: none; text-align: center; 
            max-width: 85%; z-index: 30; left: 50%; transform: translateX(-50%);
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 0px 4px 10px rgba(0,0,0,0.5);
            line-height: 1.1; pointer-events: auto; /* Permette il drag */
        }
        
        .waveform-wrapper { position: relative; width: 100%; height: 90px; background: #000; border-radius: 16px; overflow: hidden; border: 1px solid #222; }
        #audio-range-highlighter { position: absolute; top: 0; height: 100%; background: rgba(59, 130, 246, 0.15); border-left: 2px solid var(--sv-blue); border-right: 2px solid var(--sv-blue); z-index: 5; }
        #playhead { position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: #fff; z-index: 10; box-shadow: 0 0 10px rgba(255,255,255,0.8); }

        .btn-sv { background: linear-gradient(135deg, var(--sv-blue) 0%, var(--sv-purple) 100%); transition: all 0.3s ease; font-weight: 800; }
        .btn-sv:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .font-btn { background: #000; border: 1px solid #333; padding: 8px 12px; border-radius: 10px; font-size: 10px; transition: all 0.2s; }
        .font-btn.active { border-color: var(--sv-blue); background: rgba(59, 130, 246, 0.1); color: var(--sv-blue); }

        .terminal::-webkit-scrollbar { width: 4px; }
        .terminal::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* Font Styles for FFmpeg */
        .font-tiktok-ffmpeg { font-family: 'Montserrat', sans-serif; font-weight: 900; text-transform: uppercase; }
        .font-retro-ffmpeg { font-family: 'Courier Prime', monospace; }
        .font-classic-ffmpeg { font-family: 'Inter', sans-serif; font-weight: 800; }
        .font-script-ffmpeg { font-family: 'Dancing Script', cursive; font-weight: 700; }

    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
        
        <div class="flex flex-col items-center justify-center space-y-4">
            <div class="iphone-frame" id="iphone">
                <div class="notch"></div>
                <div class="video-container" id="drop-zone">
                    <video id="main-video" loop crossorigin="anonymous" playsinline></video>
                    <div id="caption-overlay" class="font-tiktok-ffmpeg" style="top: 35%; font-size: 24px; color: white;">SCRIVI IL TUO TESTO</div>
                    
                    <div class="absolute inset-0 pointer-events-none flex flex-col justify-end p-5 bg-gradient-to-t from-black/50 to-transparent">
                        <div class="flex justify-between items-end pb-4">
                            <div class="space-y-1">
                                <p class="font-bold text-sm">@soundvertise.studio</p>
                                <p class="text-[11px] opacity-90">Sincronizza i tuoi video musicali ⚡</p>
                            </div>
                            <div class="flex flex-col gap-5 items-center">
                                <i data-lucide="heart" class="w-7 h-7 fill-white"></i>
                                <i data-lucide="message-circle" class="w-7 h-7 fill-white"></i>
                                <i data-lucide="share-2" class="w-7 h-7 fill-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Anteprima in tempo reale</p>
        </div>

        <div class="bg-zinc-900/40 border border-zinc-800 p-8 rounded-[2.5rem] space-y-6 backdrop-blur-xl">
            <header class="flex justify-between items-end border-b border-zinc-800/50 pb-4">
                <div>
                    <h1 class="text-xl font-black italic uppercase italic">STUDIO <span class="text-blue-400">CREATOR</span></h1>
                    <p class="text-[9px] font-bold tracking-widest text-zinc-600">SOUNDVERTISE V1.5</p>
                </div>
                <span id="audio-time" class="text-blue-400 font-mono text-xs font-bold">0:00 / 0:00</span>
            </header>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="document.getElementById('video-input').click()" class="flex items-center justify-center gap-3 bg-black border border-zinc-800 p-4 rounded-2xl hover:border-blue-500 transition-all text-xs font-bold uppercase">
                    <i data-lucide="clapperboard" class="w-4 h-4 text-blue-400"></i> Video
                </button>
                <input type="file" id="video-input" accept="video/*" class="hidden">
                
                <button onclick="document.getElementById('audio-input').click()" class="flex items-center justify-center gap-3 bg-black border border-zinc-800 p-4 rounded-2xl hover:border-violet-500 transition-all text-xs font-bold uppercase">
                    <i data-lucide="mic-2" class="w-4 h-4 text-violet-400"></i> Audio
                </button>
                <input type="file" id="audio-input" accept="audio/*" class="hidden">
            </div>

            <div class="bg-black p-5 rounded-3xl border border-zinc-800/50 space-y-4">
                <div class="flex items-center gap-5">
                    <button id="play-btn" class="w-14 h-14 rounded-2xl btn-sv text-white flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <i data-lucide="play" id="play-icon" class="w-6 h-6 fill-white"></i>
                    </button>
                    <div class="flex-1 space-y-2">
                        <div class="waveform-wrapper" id="waveform-container">
                            <canvas id="waveform" class="w-full h-full opacity-60"></canvas>
                            <div id="audio-range-highlighter"></div>
                            <div id="playhead"></div>
                        </div>
                        <input type="range" id="audio-slider" class="w-full accent-blue-500" min="0" value="0" step="0.01">
                    </div>
                </div>
                <div class="flex justify-between items-center text-[10px] font-black uppercase text-zinc-500">
                    <span id="sync-label">Sincronizzazione: 0.0s</span>
                    <span class="text-blue-400">Trascina l'onda per tagliare l'audio</span>
                </div>
            </div>

            <div class="p-6 bg-zinc-900/60 rounded-3xl border border-zinc-800 space-y-5">
                <textarea id="caption-input" rows="2" placeholder="Scrivi il tuo testo qui..." class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-sm focus:ring-1 focus:ring-blue-500 outline-none resize-none font-semibold"></textarea>
                
                <div class="grid grid-cols-4 gap-2">
                    <button class="font-btn active" data-font="font-tiktok-ffmpeg">TIKTOK</button>
                    <button class="font-btn" data-font="font-retro-ffmpeg">RETRO</button>
                    <button class="font-btn" data-font="font-classic-ffmpeg">BOLD</button>
                    <button class="font-btn" data-font="font-script-ffmpeg">SCRIPT</button>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex-1 pr-6">
                        <input type="range" id="font-size" min="14" max="48" value="24" class="w-full accent-blue-500">
                    </div>
                    <span id="font-size-val" class="text-xs font-mono text-zinc-500">24px</span>
                </div>
            </div>

            <div class="space-y-3">
                <button id="export-btn" class="w-full btn-sv text-white font-black py-5 rounded-2xl flex items-center justify-center gap-3 uppercase tracking-widest text-xs">
                    <i data-lucide="sparkles" class="w-5 h-5"></i> Genera ed Esporta MP4 (CON TESTO!)
                </button>

                <div id="export-status" class="hidden bg-black p-4 rounded-2xl border border-zinc-800">
                    <div class="flex justify-between text-[10px] mb-2 font-black uppercase text-blue-400">
                        <span id="status-text">Analisi file...</span>
                        <span id="percent-text">0%</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-1.5 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all"></div>
                    </div>
                    <div id="terminal" class="terminal mt-3 text-[9px] font-mono text-green-500 h-20 overflow-y-auto opacity-50"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="bg-music" crossorigin="anonymous"></audio>

    <script>
        lucide.createIcons();
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        const term = document.getElementById('terminal');
        const addLog = (m) => {
            const d = document.createElement('div');
            d.innerText = `> ${m}`;
            term.appendChild(d);
            term.scrollTop = term.scrollHeight;
        };

        const ffmpeg = createFFmpeg({ 
            log: true, 
            corePath: 'https://unpkg.com/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js' 
        });

        ffmpeg.setLogger(({ message }) => addLog(message));

        const video = document.getElementById('main-video');
        const audio = document.getElementById('bg-music');
        const caption = document.getElementById('caption-overlay');
        const audioSlider = document.getElementById('audio-slider');
        const highlighter = document.getElementById('audio-range-highlighter');
        const playhead = document.getElementById('playhead');
        
        let vFile, aFile, isPlaying = false;

        // Mappatura Font per FFmpeg
        const FONT_MAP = {
            'font-tiktok-ffmpeg': { path: '/fonts/Montserrat-ExtraBold.ttf', name: 'Montserrat' },
            'font-retro-ffmpeg': { path: '/fonts/CourierPrime-Bold.ttf', name: 'Courier Prime' },
            'font-classic-ffmpeg': { path: '/fonts/Inter-Black.ttf', name: 'Inter' },
            'font-script-ffmpeg': { path: '/fonts/DancingScript-Bold.ttf', name: 'Dancing Script' }
        };
        let currentFont = FONT_MAP['font-tiktok-ffmpeg']; // Default

        // --- GESTIONE INPUT & UI ---
        document.getElementById('caption-input').oninput = (e) => caption.innerText = e.target.value || 'SCRIVI IL TUO TESTO';
        document.getElementById('font-size').oninput = (e) => {
            caption.style.fontSize = e.target.value + 'px';
            document.getElementById('font-size-val').innerText = e.target.value + 'px';
        };

        document.querySelectorAll('.font-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                caption.className = btn.dataset.font;
                currentFont = FONT_MAP[btn.dataset.font]; // Aggiorna il font per FFmpeg
            };
        });

        document.getElementById('video-input').onchange = (e) => {
            vFile = e.target.files[0];
            if (vFile) {
                video.src = URL.createObjectURL(vFile);
                video.onloadedmetadata = () => updateSyncUI();
            }
        };

        document.getElementById('audio-input').onchange = (e) => {
            aFile = e.target.files[0];
            if (aFile) {
                audio.src = URL.createObjectURL(aFile);
                audio.onloadedmetadata = () => updateSyncUI();
            }
        };

        function updateSyncUI() {
            if (audio.duration && video.duration) {
                audioSlider.max = Math.max(0, audio.duration - video.duration);
                const ratio = (video.duration / audio.duration) * 100;
                highlighter.style.width = `${Math.min(100, ratio)}%`;
            }
        }

        audioSlider.oninput = () => {
            const val = parseFloat(audioSlider.value);
            highlighter.style.left = `${(val / audio.duration) * 100}%`;
            document.getElementById('sync-label').innerText = `Sincronizzazione: ${val.toFixed(1)}s`;
            if (!isPlaying) audio.currentTime = val;
        };

        // --- PLAYBACK ---
        document.getElementById('play-btn').onclick = async () => {
            if (isPlaying) {
                video.pause(); audio.pause();
                isPlaying = false;
            } else {
                audio.currentTime = parseFloat(audioSlider.value);
                video.currentTime = 0;
                await video.play(); await audio.play();
                isPlaying = true;
            }
            document.getElementById('play-icon').setAttribute('data-lucide', isPlaying ? 'pause' : 'play');
            lucide.createIcons();
        };

        video.ontimeupdate = () => {
            if (isPlaying) {
                const ratio = video.currentTime / video.duration;
                const hLeft = parseFloat(highlighter.style.left) || 0;
                const hWidth = parseFloat(highlighter.style.width) || 0;
                playhead.style.left = `${hLeft + (ratio * hWidth)}%`;
                
                const cur = Math.floor(video.currentTime);
                const dur = Math.floor(video.duration);
                document.getElementById('audio-time').innerText = `${Math.floor(cur/60)}:${(cur%60).toString().padStart(2,'0')} / ${Math.floor(dur/60)}:${(dur%60).toString().padStart(2,'0')}`;
            }
        };

        // --- EXPORT CON TESTO ---
        document.getElementById('export-btn').onclick = async () => {
            if (!vFile) return alert("Carica un video per procedere.");
            
            document.getElementById('export-status').classList.remove('hidden');
            const progress = document.getElementById('progress-bar');
            
            try {
                if (!ffmpeg.isLoaded()) {
                    addLog("Caricamento motore video...");
                    await ffmpeg.load();
                }

                // Pulizia FS (importante prima di ogni run)
                ffmpeg.FS('unlink', 'vid.mp4'); try { ffmpeg.FS('unlink', 'aud.mp3'); } catch(e){} try { ffmpeg.FS('unlink', 'out.mp4'); } catch(e){}

                addLog("Scrittura video nel sistema virtuale...");
                ffmpeg.FS('writeFile', 'vid.mp4', await fetchFile(vFile));
                
                // --- Gestione Font per Drawtext ---
                addLog("Caricamento font per il testo...");
                // QUI DEVI CARICARE I TUOI FONT DA UNA CARTELLA /fonts nel tuo progetto Vercel
                // Per semplicità, caricherò un font generico da CDN.
                // Idealmente, avresti i tuoi file .ttf nella tua repo in una cartella /fonts
                await ffmpeg.FS('writeFile', 'font.ttf', await fetchFile('https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQsPFhExubBHsfYQ.ttf')); // Esempio: Inter Bold

                const captionText = caption.innerText.replace(/'/g, "\\'"); // Escapa apici per FFmpeg
                const fontSize = parseFloat(caption.style.fontSize);
                const textColor = caption.style.color || 'white';
                
                // Calcola la posizione Y (normalizzata da 0 a 1)
                const videoHeight = video.offsetHeight;
                const captionTop = caption.offsetTop;
                const yPos = (captionTop / videoHeight) * 100; // Percentuale
                const yDrawtext = `(H*${yPos}/100) - (text_h/2)`; // Centra il testo verticalmente
                
                const xDrawtext = `(W-text_w)/2`; // Centra il testo orizzontalmente

                // Comando drawtext con outline (border)
                const drawtextFilter = `drawtext=fontfile=/font.ttf:text='${captionText}':x=${xDrawtext}:y=${yDrawtext}:fontsize=${fontSize}:fontcolor=${textColor}:borderw=2:bordercolor=black`;
                
                let cmd = [];
                if (aFile) {
                    addLog("Scrittura audio nel sistema virtuale...");
                    ffmpeg.FS('writeFile', 'aud.mp3', await fetchFile(aFile));
                    const start = parseFloat(audioSlider.value).toString();

                    cmd = [
                        '-i', 'vid.mp4', 
                        '-ss', start, '-t', video.duration.toFixed(2), 
                        '-i', 'aud.mp3',
                        '-vf', drawtextFilter, // Applica il filtro drawtext al video
                        '-map', '0:v:0', '-map', '1:a:0', 
                        '-c:v', 'libx264', '-preset', 'medium', '-crf', '23', // Codifica video con drawtext
                        '-c:a', 'aac', '-b:a', '192k', '-shortest', 'out.mp4'
                    ];
                } else {
                    cmd = [
                        '-i', 'vid.mp4', 
                        '-vf', drawtextFilter, 
                        '-c:v', 'libx264', '-preset', 'medium', '-crf', '23',
                        'out.mp4'
                    ];
                }

                addLog("Avvio rendering video CON TESTO (potrebbe richiedere tempo)...");
                await ffmpeg.run(...cmd);

                const data = ffmpeg.FS('readFile', 'out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                const link = document.createElement('a');
                link.href = url;
                link.download = `Soundvertise_Con_Testo_${Date.now()}.mp4`;
                link.click();
                
                addLog("Export terminato CON TESTO!");

            } catch (err) {
                addLog("ERRORE DURANTE EXPORT: " + err.message);
                console.error(err);
            }
        };

        // --- DRAG TESTO ---
        let drag = false, startY;
        caption.onmousedown = (e) => { drag = true; startY = e.clientY - caption.offsetTop; };
